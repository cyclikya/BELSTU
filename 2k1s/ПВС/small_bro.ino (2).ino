#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 32
#define OLED_RESET -1  // Указываем, что пин сброса не используется

Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

const int Dry = 5;   
const int Dark = 3;    
const int Touch = 4;
const int photoPin = A0; // Аналоговый пин с фотодиода

static const unsigned char PROGMEM eye0[] =
{
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
};

static const unsigned char PROGMEM eye1[] =
{
  B00000111, B11111111, B11111111, B11100000,
  B00011111, B11111111, B11111111, B11111000,
  B00111111, B11111111, B11111111, B11111100,
  B01111111, B11111111, B11111111, B11111110,
  B01111111, B11111111, B11111111, B11111110,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B01111111, B11111111, B11111111, B11111110,
  B01111111, B11111111, B11111111, B11111110,
  B00111111, B11111111, B11111111, B11111100,
  B00011111, B11111111, B11111111, B11111000,
  B00000111, B11111111, B11111111, B11100000,
};

static const unsigned char PROGMEM eye4[] =
{
  B00000111, B11111111, B11111111, B11100000,
  B00011111, B11111111, B11111111, B11111000,
  B00111111, B11111111, B11111111, B11111100,
  B01111111, B11111111, B11111111, B11111110,
  B01111111, B11111111, B11111111, B11111110,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111000, B00000000, B00000000, B00011111,
  B11100000, B00000000, B00000000, B00000111,
  B11000000, B00000000, B00000000, B00000011,
  B10000000, B00000000, B00000000, B00000001,
  B10000000, B00000000, B00000000, B00000001,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
};

static const unsigned char PROGMEM eye5[] =
{
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B01111111, B11111110, B00000000,
  B00000001, B11111111, B11111111, B10000000,
  B00000011, B11111111, B11111111, B11000000,
  B00000111, B11111111, B11111111, B11100000,
  B00000111, B11111111, B11111111, B11100000,
  B00001111, B11111111, B11111111, B11110000,
  B00001111, B10000000, B00000001, B11110000,
  B00001110, B00000000, B00000000, B01110000,
  B00001100, B00000000, B00000000, B00110000,
  B00001000, B00000000, B00000000, B00010000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
};

static const unsigned char PROGMEM eye7[] =
{
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B01111111, B11111111, B11111111, B11111110,
  B01111111, B11111111, B11111111, B11111110,
  B00111111, B11111111, B11111111, B11111100,
  B00011111, B11111111, B11111111, B11111000,
  B00000111, B11111111, B11111111, B11100000,
};

static const unsigned char PROGMEM eye8[] =
{
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00001111, B11111111, B11111111, B11110000,
  B00001111, B11111111, B11111111, B11110000,
  B00001111, B11111111, B11111111, B11110000,
  B00001111, B11111111, B11111111, B11110000,
  B00001111, B11111111, B11111111, B11110000,
  B00001111, B11111111, B11111111, B11110000,
  B00001111, B11111111, B11111111, B11110000,
  B00000111, B11111111, B11111111, B11100000,
  B00000111, B11111111, B11111111, B11100000,
  B00000011, B11111111, B11111111, B11000000,
  B00000001, B11111111, B11111111, B10000000,
  B00000000, B01111111, B11111110, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
};

static const unsigned char PROGMEM eye9[] =
{
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00001111, B11111111, B11111111, B11110000,
  B00001111, B11111111, B11111111, B11110000,
  B00001111, B11111111, B11111111, B11110000,
  B00001111, B11111111, B11111111, B11110000,
  B00001111, B11111111, B11111111, B11110000,
  B00001111, B11111111, B11111111, B11110000,
  B00001111, B11111111, B11111111, B11110000,
  B00001111, B11111111, B11111111, B11110000,
  B00001111, B11111111, B11111111, B11110000,
  B00001111, B11111111, B11111111, B11110000,
  B00001111, B11111111, B11111111, B11110000,
  B00000111, B11111111, B11111111, B11100000,
  B00000111, B11111111, B11111111, B11100000,
  B00000011, B11111111, B11111111, B11000000,
  B00000001, B11111111, B11111111, B10000000,
  B00000000, B01111111, B11111110, B00000000,
};

static const unsigned char PROGMEM eye10i[] =
{
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000010,
  B00000000, B00000000, B00000000, B00011111,
  B00000000, B00000000, B00000000, B11111111,
  B00000000, B00000000, B00000111, B11111111,
  B00000000, B00000000, B00111111, B11111111,
  B00000000, B00000001, B11111111, B11111111,
  B00000000, B00001111, B11111111, B11111111,
  B00000000, B01111111, B11111111, B11111111,
  B00000011, B11111111, B11111111, B11111111,
  B00011111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B11111111, B11111111, B11111111, B11111111,
  B01111111, B11111111, B11111111, B11111110,
  B01111111, B11111111, B11111111, B11111110,
  B00111111, B11111111, B11111111, B11111100,
  B00011111, B11111111, B11111111, B11111000,
  B00000111, B11111111, B11111111, B11100000,
};

bool isMessageDisplayed = false; 
bool isSleeping = false; // Флаг для состояния сна
unsigned long lastPressedTime = 0; // Время последнего переключения
unsigned long displayDuration = 500; // Время отображения сообщения в мс

void setup() {
    pinMode(Dark, INPUT_PULLUP);   // Настраиваем пины как INPUT_PULLUP
    pinMode(Dry, INPUT_PULLUP);
    pinMode(Touch, INPUT_PULLUP);
    pinMode(photoPin, INPUT); // Настраиваем пин фотодиода как вход

    // Инициализируем дисплей с адресом 0x3C
    if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
        Serial.println(F("SSD1306 allocation failed"));
        for (;;); // Остановить, если дисплей не обнаружен
    }

    display.clearDisplay();
    display.display();

    // Показ начального состояния глаз (eye3)
    display.drawBitmap(20, 0, eye9, 32, 32, WHITE); // Левый глаз
    display.drawBitmap(76, 0, eye9, 32, 32, WHITE); // Правый глаз
    display.display();
    delay(1000);
}

void loop() {
    int lightLevel = analogRead(photoPin); // Читаем уровень света

    if (lightLevel < 200) { // Если темно
        if (!isSleeping) { // Если мы еще не спим
            sleepMode();
        }
    } else { // Если светло
        isSleeping = false; // Выходим из режима сна

        //постоянное моргание
        if (!isMessageDisplayed) {
            blinking()
        }

        // Касание
        if (digitalRead(Touch) == LOW && !isMessageDisplayed) {
            display.clearDisplay();
            isMessageDisplayed = true;

            // Радость
            while (digitalRead(Touch) == LOW) {
                joy();
            }
            isMessageDisplayed = false;
        }

        if (digitalRead(Dark) == LOW && !isMessageDisplayed) { 
            isMessageDisplayed = true; 
            for (int i = 0; i < 2; i++) { 
                blinkEyes(); 
            } 
            closeEyes();

            while (digitalRead(Dark) == LOW) { 
                animateZs(); 
            } 

            isMessageDisplayed = false; 
        }

        if (digitalRead(Dry) == LOW && !isMessageDisplayed) {
            display.clearDisplay();
            display.setCursor(0 ,0);
            display.println("Too Dry!!!");
            display.display();
            lastPressedTime = millis();
            isMessageDisplayed = true;
            delay(50);
        }
    }
}

void sleepMode() {
    isSleeping = true; 
    while (analogRead(photoPin) < 200) { 
        closeEyes(); 
        delay(300);
        animateZs(); 
    }
}

void blinking() {
  display.clearDisplay();
  display.drawBitmap(20, 0, eye1, 32, 32, WHITE); // Левый глаз
  display.drawBitmap(76, 0, eye1, 32, 32, WHITE); // Правый глаз
  display.display();
  delay(500);

  display.clearDisplay();
  display.drawBitmap(20, 0, eye0, 32, 32, WHITE); // Левый глаз
  display.drawBitmap(76, 0, eye0 ,32 ,32 ,WHITE); // Правый глаз
  display.display();
  delay(500);
}

void joy() {
  display.clearDisplay();
  display.drawBitmap(20, 0, eye4, 32, 32, WHITE); // Левый глаз
  display.drawBitmap(76, 0, eye4, 32, 32, WHITE); // Правый глаз
  display.display();
  delay(500);

  display.clearDisplay();
  display.drawBitmap(20, 0, eye5, 32, 32, WHITE); // Левый глаз
  display.drawBitmap(76, 0, eye5, 32, 32, WHITE); // Правый глаз
  display.display();
  delay(500);
}

